.. Copyright (C) 2015, Wazuh, Inc.

.. meta::
  :description: Learn how you can identify malware properties, activities, network connections, and more using Wazuh modules in this use case.
  
Malware detection
-----------------

Malware, short for malicious software, refers to any software specifically designed to harm or exploit computer systems, networks, or users. It is created with the intention of gaining unauthorized access, causing damage, stealing sensitive information, or performing other malicious activities on a target system. There are various types of malware, each with specific functions and infection methods. Some common types of malware include viruses, worms, ransomware, botnets, spyware, trojans, and rootkits.

Malware detection is crucial for safeguarding computer systems and networks from cyber threats. It helps identify and mitigate malicious software that can cause a data breach, system compromise, and financial loss.

Wazuh for malware detection
^^^^^^^^^^^^^^^^^^^^^^^^^^^
Traditional methods, which rely solely on signature-based detections, have limitations and fail to capture new threats. Signature-based approaches struggle with detecting zero-day attacks, polymorphic malware, and other evasion techniques employed by threat actors. As a result, organizations are at risk of undetected breaches and data exfiltration. Wazuh empowers organizations to detect and respond to sophisticated and evasive threats effectively. Wazuh encompasses different modules that identify malware properties, activities, network connections, and more.

Detecting malicious activities with threat detection rules
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Wazuh has threat detection rules that enable behavior-based malware detection. Instead of relying solely on predefined signatures, Wazuh focuses on monitoring and analyzing abnormal behavior exhibited by malware. This allows Wazuh to detect known and previously unknown threats. This way, Wazuh provides a proactive and adaptable defense against cyber threats.
Wazuh has out-of-the-box rulesets that are specifically designed to trigger alerts for recognized malware patterns, providing a quick response to potential security incidents. For example, the image below shows an alert with rule ID ``92213`` triggered when an executable is dropped in a folder commonly used by malware. This alert prompts security teams to begin the investigation and remediation process.

.. thumbnail:: /images/getting-started/use-cases/malware-detection/executable-dropped-in-folder.png
   :title: Executable dropped in folder used by malware alert
   :alt: Executable dropped in folder used by malware alert
   :align: center
   :width: 80%

Wazuh allows users to create :doc:`custom rules </user-manual/ruleset/custom>` for more flexibility in detection, empowering them to focus on relevant activities, and optimizing malware detection. Wazuh decodes and organizes logs from monitored endpoints into fields, which can then be utilized to create custom rules for alerting when malicious activity is detected.

Wazuh rules use multiple fields that denote indicators of compromise (IOCs) to reduce false positives and detect known malware based on specific behaviors. These rules can connect related malware activities, such as intrusion, privilege escalation, lateral movement, obfuscation, and exfiltration for comprehensive detection.

Below is an example of some Wazuh custom rules created to alert on malicious activities of the LimeRAT malware:

.. code-block:: xml
   :emphasize-lines: 3,8,14,20,26,30,37,42

   <group name="lime_rat,sysmon,">

     <!-- Rogue create netflix.exe creation -->
     <rule id="100024" level="12">
       <if_sid>61613</if_sid>
       <field name="win.eventdata.image" type="pcre2">\.exe</field>
       <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+\\\\AppData\\\\Roaming\\\\checker netflix\.exe</field>
       <description>Potential LimeRAT activity detected: checker netflix.exe created at $(win.eventdata.targetFilename) by $(win.eventdata.image).</description>
       <mitre>
         <id>T1036</id>
       </mitre>
     </rule>

     <!-- Registry key creation for persistence -->
     <rule id="100025" level="12">
       <if_group>sysmon</if_group>
       <field name="win.eventdata.details" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+\\\\AppData\\\\Roaming\\\\checker netflix\.exe</field>
       <field name="win.eventdata.targetObject" type="pcre2" >HKU\\\\.+\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\checker netflix\.exe</field>
       <field name="win.eventdata.eventType" type="pcre2" >^SetValue$</field>
       <description>Potential LimeRAT activity detected:  $(win.eventdata.details) added itself to the Registry as a startup program $(win.eventdata.targetObject) to establish persistence.</description>
       <mitre>
         <id>T1547.001</id>
       </mitre>
     </rule>

     <!-- Network activity detection -->
     <rule id="100026" level="12">
       <if_sid>61605</if_sid>
       <field name="win.eventdata.image" type="pcre2">(?i)[c-z]:\\\\Users\\\\.+\\\\AppData\\\\Roaming\\\\checker netflix\.exe</field>
       <description>Potential LimeRAT activity detected: Suspicious DNS query made by $(win.eventdata.image).</description>
       <mitre>
         <id>T1572</id>
       </mitre>
     </rule>


     <!-- LimeRAT service creation -->
     <rule id="100028" level="12">
       <if_sid>61614</if_sid>
       <field name="win.eventdata.targetObject" type="pcre2" >HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\disk</field>
       <field name="win.eventdata.eventType" type="pcre2" >^CreateKey$</field>
       <description>Potential LimeRAT activity detected: LimeRAT service $(win.eventdata.targetObject) has been created on $(win.system.computer).</description>
         <mitre>
       <id>T1543.003</id>
         </mitre>
     </rule>

   </group>

These rules create alerts that are visible in the Security Events module on the Wazuh dashboard.

.. thumbnail:: /images/getting-started/use-cases/malware-detection/limerat-custom-alerts-example.png
   :title: LimeRAT custom alerts example
   :alt: LimeRAT custom alerts example
   :align: center
   :width: 80%

Refer to the blog post on `LimeRat detection and response with Wazuh <https://wazuh.com/blog/limerat-detection/>`__ for the full configuration.

Wazuh identifies behavior indicative of malware, it generates real-time alerts and notifications, enabling security teams to respond swiftly and mitigate potential risks before they escalate.

Leveraging file integrity monitoring for detecting malware activity
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
