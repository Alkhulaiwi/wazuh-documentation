.. Copyright (C) 2015, Wazuh, Inc.

.. meta::
   :description: Vulnerability Detection is one of the Wazuh capabilities. Learn more about how it works and the repositories it uses.

How it works
============

To detect vulnerabilities, Wazuh agents collect a list of installed applications from monitored endpoints and send it periodically to the Wazuh server. Local SQLite databases in the Wazuh server store this list. Also, the Wazuh server builds a global vulnerability database from publicly available CVE repositories. It uses this database to cross-correlate this information with the application inventory data of the agent. The database location is ``/var/ossec/queue/vulnerabilities/cve.db``, and users can query the database using ``SQLite``:

#. Start SQLite and open the vulnerability database using the following command.

   .. code-block:: console

      # sqlite3 /var/ossec/queue/vulnerabilities/cve.db

#. List the tables in the database using the following command.

   .. code-block:: sqlite3

      sqlite> .tables

#. Retrieve the data in a table by running the following command.

   .. code-block:: sqlite3

      sqlite> select * from <table>;

.. warning::
   
   Donâ€™t make changes to the database. It can lead to issues when the Vulnerability Detector is running a scan.

The Wazuh server automatically creates the global vulnerability database with data from the following repositories:

-  https://canonical.com: Used to pull CVEs for Ubuntu Linux distributions.
-  https://www.redhat.com: Used to pull CVEs for Red Hat and CentOS Linux distributions.
-  https://www.debian.org: Used to pull CVEs for Debian Linux distributions.
-  https://security.archlinux.org: Used to pull CVEs for Arch Linux distributions.
-  https://nvd.nist.gov: Used to pull CVEs from the National Vulnerability Database.
-  https://feed.wazuh.com: Used to pull Microsoft Security Updates (MSU) and ALAS feeds. The feeds contain CVE and patch information for Microsoft products and Amazon Linux. They use the `Microsoft Update Catalog <https://www.catalog.update.microsoft.com/>`__ and the `Amazon Linux Security Center <https://alas.aws.amazon.com/>`__ as sources of information. Wazuh parses and formats the data before uploading them to the Wazuh feed.

Wazuh updates this database on a regular basis, ensuring the solution checks for the latest CVEs. You can configure the update interval.

Once the Vulnerability Detector module has created the global vulnerability database containing the CVEs, the detection process looks for vulnerable packages in the inventory databases. These inventories are unique to each agent. A package is labeled as vulnerable when its version matches those within the affected range of a CVE. Alerts show the results, and the module stores the findings in a per-agent vulnerability inventory. This inventory contains the current state of every agent and includes vulnerabilities that have been detected and not resolved. Users can :doc:`query the inventory </user-manual/capabilities/system-inventory/index>` to check for alerts and vulnerability information.

For Microsoft Windows systems and specific Microsoft products, the Vulnerability Detector has the ``hotfixes`` option in the syscollector settings on the Wazuh agent. Using this option enables the module to detect packages that the user has patched. When the Vulnerability Detector detects a patch, it uses the information provided by Microsoft to decide if the patch has resolved the CVEs. Then, it removes them from the list of vulnerabilities.

Alert generation
----------------

The Vulnerability Detector generates alerts during the baseline scan for every detected vulnerability. You can see this workflow in the diagram below.

.. thumbnail:: /images/manual/vuln-detector/vuln-detector-workflow.png
    :title: Vulnerability detector workflow
    :alt: Vulnerability detector workflow
    :align: center
    :width: 80%

The Vulnerability Detector also generates alerts when it detects new vulnerabilities or when users fix identified vulnerabilities.

.. thumbnail:: /images/manual/vuln-detector/vuln-detector-alerts.png
    :title: Vulnerability detector alerts
    :alt: Vulnerability detector alerts    
    :align: center
    :width: 80%

.. _vuln_det_compatibility_matrix:

Compatibility matrix
--------------------

The following table shows the operating systems the Vulnerability Detector currently supports and the provider(s) needed for each distribution.

+---------------+------------------------+-----------------------------------+
| Distribution  | Versions               | Provider                          |
+===============+========================+===================================+
|               | 5                      |                                   |
|               +------------------------+                                   |
|  CentOS       | 6                      |                                   |
|               +------------------------+                                   |
|               | 7                      | - Red Hat                         |
|               +------------------------+ - National Vulnerability Database |
|               | 8                      |                                   |
|               +------------------------+                                   |
|               | 9                      |                                   |
+---------------+------------------------+-----------------------------------+
|               | 5                      |                                   |
|               +------------------------+                                   |
|               | 6                      |                                   |
|               +------------------------+                                   |
|  Red Hat      | 7                      | - Red Hat                         |
|               +------------------------+ - National Vulnerability Database |
|               | 8                      |                                   |
|               +------------------------+                                   |
|               | 9                      |                                   |
+---------------+------------------------+-----------------------------------+
|               | trusty / 14            |                                   |
|               +------------------------+                                   |
| Ubuntu        | xenial / 16            |                                   |
|               +------------------------+ - Canonical                       |
|               | bionic / 18            | - National Vulnerability Database |
|               +------------------------+                                   |
|               | focal / 20             |                                   |
|               +------------------------+                                   |
|               | jammy / 22             |                                   |
+---------------+------------------------+-----------------------------------+
| Debian        | buster / 10            | - Debian                          |
|               +------------------------+ - National Vulnerability Database |
|               | bullseye / 11          |                                   |
+---------------+------------------------+-----------------------------------+
|               | Amazon Linux 1         | - ALAS                            |
| Amazon Linux  +------------------------+ - National Vulnerability Database |
|               | Amazon Linux 2         |                                   |
+---------------+------------------------+-----------------------------------+
|               |                        |                                   |
| Arch Linux    | Rolling release        | - Arch                            |
|               |                        | - National Vulnerability Database |
+---------------+------------------------+-----------------------------------+
|               | SLES 11 server         |                                   |
|               +------------------------+                                   |
|               | SLED 11 desktop        | - SUSE                            |
|               +------------------------+ - National Vulnerability Database |
|               | SLES 12 server         |                                   |
| SUSE          +------------------------+                                   |
|               | SLED 12 desktop        |                                   |
|               +------------------------+                                   |
|               | SLES 15 server         |                                   |
|               +------------------------+                                   |
|               | SLED 15 desktop        |                                   |
+---------------+------------------------+-----------------------------------+
|               |                        |                                   |
| Windows       | Windows XP and later   | - National Vulnerability Database |
|               |                        | - MSU                             |
+---------------+------------------------+-----------------------------------+
|               |                        |                                   |
| macOS         | macOS Sierra and later | - National Vulnerability Database |
|               |                        |                                   |
+---------------+------------------------+-----------------------------------+

.. note::
   
   Users can extend support for operating systems that aren't listed above by using the :doc:`allow <allow-os>` option.
